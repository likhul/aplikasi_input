<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Akademik | Input & Lihat Nilai</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="./css/style.css" rel="stylesheet"> 
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Gaya bantu untuk mengatur tampilan konten */
        #tampilanTabel {
            display: none; /* Sembunyikan tabel secara default */
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="#">Portal Akademik</a>
            <div class="collapse navbar-collapse justify-content-end">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link active" href="#" id="linkInput">Input Nilai</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="linkLihat">Lihat Data Mahasiswa</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <div id="tampilanForm" class="row justify-content-center">
            <div class="col-lg-5 col-md-8">
                <div class="card p-4 shadow card-input-form"> 
                    <h4 class="card-title text-center mb-4">Formulir Input Nilai</h4> 

                    <form id="formInputNilai">
                        <div class="mb-3">
                            <label for="namaLengkap" class="form-label">Nama Lengkap</label>
                            <input type="text" class="form-control" id="namaLengkap" placeholder="Masukkan nama lengkap" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="nim" class="form-label">NIM (Nomor Induk Mahasiswa)</label>
                            <input type="text" class="form-control" id="nim" placeholder="Contoh: 10119001" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="mataKuliah" class="form-label">Mata Kuliah</label>
                            <select class="form-select" id="mataKuliah" required>
                                <option value="">Pilih mata kuliah..</option>
                                <option value="MK001">Kalkulus I</option> 
                                <option value="MK002">Fisika Dasar</option>
                                <option value="MK003">Algoritma & Pemrograman</option>
                                <option value="MK004">Bahasa Indonesia</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label for="nilaiMahasiswa" class="form-label">Nilai Mahasiswa</label>
                            <input type="number" step="0.1" class="form-control" id="nilaiMahasiswa" placeholder="85.5" required min="0" max="100">
                        </div>

                        <button type="submit" class="btn btn-primary w-100" id="simpanDataBtn">Simpan Data</button>

                    </form>
                </div>
            </div>
        </div>
        
        <div id="tampilanTabel" class="row justify-content-center">
            <div class="col-md-11">
                <div class="card p-4 shadow">
                    <h4 class="card-title text-center mb-4">Data Nilai Mahasiswa</h4>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover"> 
                            <thead>
                                <tr>
                                    <th class="text-center">No.</th>
                                    <th>Nama Lengkap</th>
                                    <th class="text-center">NIM</th>
                                    <th>Mata Kuliah</th>
                                    <th class="text-center">Nilai</th>
                                    <th class="text-center">Aksi</th> 
                                </tr>
                            </thead>
                            <tbody id="dataNilaiBody"> 
                                <tr><td colspan="6" class="text-center p-3">Data Kosong.</td></tr> 
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        // Import library Firebase versi 9 modular dari CDN 
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Konfigurasi dan Inisialisasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDM_9G09-2UkZnayStk62ILtvjLD2kdHBc", 
            authDomain: "aplikasi-input-nilai-mah-17427.firebaseapp.com", 
            projectId: "aplikasi-input-nilai-mah-17427", 
            storageBucket: "aplikasi-input-nilai-mah-17427.firebasestorage.app", 
            messagingSenderId: "465203677701", 
            appId: "1:465203677701:web:661643994091af3551ea6c" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // --- DOM ELEMENTS UNTUK PERPINDAHAN TAMPILAN ---
        const tampilanForm = document.getElementById('tampilanForm');
        const tampilanTabel = document.getElementById('tampilanTabel');
        const linkInput = document.getElementById('linkInput');
        const linkLihat = document.getElementById('linkLihat');

        const gantiTampilan = (tujuan) => {
            if (tujuan === 'form') {
                tampilanForm.style.display = 'flex';
                tampilanTabel.style.display = 'none';
                linkInput.classList.add('active');
                linkLihat.classList.remove('active');
            } else if (tujuan === 'tabel') {
                tampilanForm.style.display = 'none';
                tampilanTabel.style.display = 'flex';
                linkInput.classList.remove('active');
                linkLihat.classList.add('active');
                loadData('dataNilaiBody'); // Muat data saat beralih ke tampilan tabel
            }
        }
        // --- END DOM FUNCTIONS ---

        // FUNGSI PEMBANTU: Untuk mendapatkan Nama Mata Kuliah
        const getNamaMataKuliah = (kode) => {
            switch (kode) {
                case 'MK001': return 'Kalkulus I';
                case 'MK002': return 'Fisika Dasar';
                case 'MK003': return 'Algoritma & Pemrograman';
                case 'MK004': return 'Bahasa Indonesia';
                default: return 'Kode Tidak Dikenal';
            }
        };

        // FUNGSI PEMBANTU: Untuk menghasilkan HTML <select> Mata Kuliah (digunakan untuk Edit)
        const generateMataKuliahSelect = (currentKode) => {
            const options = [
                { kode: 'MK001', nama: 'Kalkulus I' }, 
                { kode: 'MK002', nama: 'Fisika Dasar' },
                { kode: 'MK003', nama: 'Algoritma & Pemrograman' },
                { kode: 'MK004', nama: 'Bahasa Indonesia' },
            ];
            
            let selectHtml = `<select id="swal-input-mk" class="swal2-select" required>`;
            selectHtml += `<option value="">Pilih mata kuliah..</option>`;

            options.forEach(opt => {
                const selected = opt.kode === currentKode ? 'selected' : ''; 
                selectHtml += `<option value="${opt.kode}" ${selected}>${opt.nama}</option>`;
            });

            selectHtml += `</select>`;
            return selectHtml;
        };

        // Fungsi 1: validasiInput()
        const validasiInput = (nama, nim, mataKuliah, nilai) => {
            if (!nama || !nim || !mataKuliah || !nilai) {
                Swal.fire({ 
                    icon: 'warning',
                    title: 'Validasi Gagal',
                    text: 'Semua field harus diisi!',
                });
                return false;
            }

            const nilaiAngka = parseFloat(nilai);
            if (isNaN(nilaiAngka) || nilaiAngka < 0 || nilaiAngka > 100) {
                Swal.fire({
                    icon: 'error',
                    title: 'Input Salah',
                    text: 'Nilai harus berupa angka (0 - 100)!',
                });
                return false;
            }

            return true; 
        };

        // Fungsi 2: simpanData() (CREATE)
        const simpanData = async (data) => {
            try {
                await addDoc(collection(db, "Nilai"), {
                    nama: data.nama,
                    nim: data.nim,
                    kode_mk: data.kode_mk,
                    nilai: data.nilaiAngka
                });

                const mataKuliahNama = getNamaMataKuliah(data.kode_mk);
                
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'success',
                    title: 'Data berhasil disimpan!',
                    html: `
                        <div style="text-align: left; padding: 10px; font-size: 0.9rem;">
                            <p style="margin-bottom: 5px;"><strong>Nama:</strong> ${data.nama}</p>
                            <p style="margin-bottom: 5px;"><strong>Mata Kuliah:</strong> ${data.kode_mk} - ${mataKuliahNama}</p>
                            <p style="margin-bottom: 0;"><strong>Nilai:</strong> ${data.nilaiAngka}</p>
                        </div>
                    `,
                    showConfirmButton: false,
                    timer: 3500,
                    timerProgressBar: true
                });
                return true;
            } catch (e) {
                console.error("Error adding document: ", e);
                Swal.fire({
                    icon: 'error',
                    title: 'Gagal Menyimpan',
                    text: 'Terjadi kesalahan saat menyimpan data. Cek koneksi Anda!',
                });
                return false;
            }
        };

        // FUNGSI UTAMA: Edit Nilai (UPDATE)
        const editNilai = async (docId, itemData) => { 
            const mkSelectHtml = generateMataKuliahSelect(itemData.kode_mk);

            const result = await Swal.fire({
                title: `Edit Data: ${itemData.nama}`,
                html: `
                    <div style="text-align: left; margin-bottom: 20px;">
                        
                        <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <label for="swal-input-nama" class="swal2-label" style="text-align: left; display: block; margin-bottom: 5px; font-weight: 600;">Nama Lengkap:</label>
                                <input id="swal-input-nama" class="swal2-input" value="${itemData.nama}" style="width: 100%; margin: 0;">
                            </div>

                            <div style="flex: 1;">
                                <label for="swal-input-nim" class="swal2-label" style="text-align: left; display: block; margin-bottom: 5px; font-weight: 600;">NIM:</label>
                                <input id="swal-input-nim" class="swal2-input" value="${itemData.nim}" style="width: 100%; margin: 0;">
                            </div>
                        </div>

                        <label for="swal-input-mk" class="swal2-label" style="text-align: left; display: block; margin-bottom: 5px; margin-top: 15px; font-weight: 600;">Mata Kuliah:</label>
                        ${mkSelectHtml.replace(
                            `<select id="swal-input-mk" class="swal2-select" required>`, 
                            `<select id="swal-input-mk" class="swal2-select" required style="width: 100%; margin: 0 0 10px 0;">`
                        )}

                        <label for="swal-input-nilai" class="swal2-label" style="text-align: left; display: block; margin-bottom: 5px; font-weight: 600;">Nilai (0-100):</label>
                        <input id="swal-input-nilai" class="swal2-input" type="number" step="0.1" value="${itemData.nilai}" style="width: 100%; margin: 0;">
                    </div>
                `,
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'Simpan Perubahan',
                cancelButtonText: 'Batal',
                focusConfirm: false,
                preConfirm: () => {
                    const nama = document.getElementById('swal-input-nama').value.trim();
                    const nim = document.getElementById('swal-input-nim').value.trim();
                    const kode_mk = document.getElementById('swal-input-mk').value;
                    const nilaiBaru = document.getElementById('swal-input-nilai').value.trim();
                    
                    const nilaiAngka = parseFloat(nilaiBaru);

                    if (!nama || !nim || !kode_mk || !nilaiBaru) {
                        Swal.showValidationMessage('Semua field harus diisi!');
                        return false;
                    }
                    if (isNaN(nilaiAngka) || nilaiAngka < 0 || nilaiAngka > 100) {
                        Swal.showValidationMessage('Nilai harus berupa angka antara 0 hingga 100!');
                        return false;
                    }
                    
                    return { nama, nim, kode_mk, nilai: nilaiAngka };
                }
            });

            if (result.isConfirmed) {
                const dataBaru = result.value;
                try {
                    const docRef = doc(db, "Nilai", docId);
                    await updateDoc(docRef, dataBaru);

                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'success',
                        title: 'Data berhasil diperbarui!',
                        showConfirmButton: false,
                        timer: 2000
                    });
                    
                    loadData('dataNilaiBody');

                } catch (e) {
                    console.error("Error updating document: ", e);
                    Swal.fire({
                        icon: 'error',
                        title: 'Gagal Update',
                        text: 'Terjadi kesalahan saat memperbarui data!',
                    });
                }
            }
        };


        // FUNGSI: Konfirmasi dan Hapus Data (DELETE)
        const hapusData = async (docId) => {
            const result = await Swal.fire({
                title: 'Anda Yakin?',
                text: "Data yang sudah dihapus tidak dapat dikembalikan!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Ya, Hapus Data!',
                cancelButtonText: 'Batal'
            });

            if (result.isConfirmed) {
                try {
                    await deleteDoc(doc(db, "Nilai", docId));

                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'success',
                        title: 'Data berhasil dihapus!',
                        showConfirmButton: false,
                        timer: 2000
                    });
                    
                    loadData('dataNilaiBody');

                } catch (e) {
                    console.error("Error deleting document: ", e);
                    Swal.fire({
                        icon: 'error',
                        title: 'Gagal Hapus',
                        text: 'Terjadi kesalahan saat menghapus data. Cek koneksi Anda!',
                    });
                }
            }
        };

        // Fungsi 3: loadData() (READ)
        const loadData = async (tabelBodyId) => {
            const dataNilai = [];
            
            Swal.fire({
                title: 'Memuat Data...',
                text: 'Sedang mengambil data nilai mahasiswa dari server.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                const querySnapshot = await getDocs(collection(db, "Nilai"));

                querySnapshot.forEach((doc) => {
                    dataNilai.push({ id: doc.id, ...doc.data() }); 
                });
                
                Swal.close();

                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'info',
                    title: `Memuat ${dataNilai.length} data nilai berhasil.`,
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true
                });

                tampilkanDataTabel(dataNilai, tabelBodyId);
                return dataNilai;

            } catch (e) {
                console.error("Error loading documents: ", e);
                Swal.fire({
                    icon: 'error',
                    title: 'Gagal Memuat Data',
                    text: 'Terjadi kesalahan saat memuat data nilai.',
                });
                Swal.close();
                return [];
            }
        };

        // Fungsi pembantu untuk menampilkan data ke tabel HTML
        const tampilkanDataTabel = (data, tabelBodyId) => {
            const tabelBody = document.getElementById(tabelBodyId);
            if (!tabelBody) return;

            tabelBody.innerHTML = ''; 

            if (data.length === 0) {
                const row = tabelBody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 6; 
                cell.className = 'text-center p-3';
                cell.textContent = 'Tidak ada data nilai yang tersimpan.';
                return;
            }

            data.forEach((item, index) => {
                const row = tabelBody.insertRow();
                
                row.insertCell(0).textContent = index + 1;
                row.cells[0].className = 'text-center'; 

                row.insertCell(1).textContent = item.nama;
                
                row.insertCell(2).textContent = item.nim;
                row.cells[2].className = 'text-center'; 
                
                const namaMK = getNamaMataKuliah(item.kode_mk);
                row.insertCell(3).textContent = `${item.kode_mk} - ${namaMK}`;
                
                row.insertCell(4).textContent = item.nilai;
                row.cells[4].className = 'text-center'; 

                const aksiCell = row.insertCell(5);
                aksiCell.className = 'text-center'; 

                const editBtn = document.createElement('button');
                editBtn.textContent = 'Edit';
                editBtn.className = 'btn btn-aksi-edit'; 
                editBtn.setAttribute('data-id', item.id); 
                editBtn.addEventListener('click', () => {
                    editNilai(item.id, item);
                });
                
                const hapusBtn = document.createElement('button');
                hapusBtn.textContent = 'Hapus';
                hapusBtn.className = 'btn btn-aksi-hapus'; 
                hapusBtn.setAttribute('data-id', item.id);
                hapusBtn.addEventListener('click', () => {
                    hapusData(item.id); 
                });

                aksiCell.appendChild(editBtn);
                aksiCell.appendChild(hapusBtn);
            });
        }

        // Event Listener Utama
        document.addEventListener('DOMContentLoaded', () => {
            // Inisialisasi tampilan awal
            gantiTampilan('form'); 

            // Navigasi Bar Event Listeners
            linkInput.addEventListener('click', (e) => {
                e.preventDefault();
                gantiTampilan('form');
            });

            linkLihat.addEventListener('click', (e) => {
                e.preventDefault();
                gantiTampilan('tabel');
            });
            
            const simpanBtn = document.getElementById('simpanDataBtn');

            if (simpanBtn) {
                // Logic untuk Form Input Nilai
                simpanBtn.addEventListener('click', async (e) => {
                    e.preventDefault(); 

                    const nama = document.getElementById('namaLengkap').value.trim();
                    const nim = document.getElementById('nim').value.trim();
                    const mataKuliah = document.getElementById('mataKuliah').value; 
                    const nilai = document.getElementById('nilaiMahasiswa').value.trim();

                    if (validasiInput(nama, nim, mataKuliah, nilai)) { 
                        const dataSimpan = {
                            nama,
                            nim,
                            kode_mk: mataKuliah,
                            nilaiAngka: parseFloat(nilai)
                        };

                        const berhasilSimpan = await simpanData(dataSimpan); 

                        if (berhasilSimpan) {
                            document.getElementById('formInputNilai').reset();
                            // >>> PERUBAHAN: Ganti tampilan ke tabel setelah berhasil simpan <<<
                            gantiTampilan('tabel');
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>